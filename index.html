<!DOCTYPE html>
<html>
<head>
  <title>TON Farm</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    body {
      font-family: "Press Start 2P", system-ui, monospace;
      text-align: center;
      background: #87ceeb;
      margin: 0;
      padding: 0;
    }

    .game-container {
      max-width: 420px;
      margin: 0 auto;
      background: #6ab04c;
      border: 8px solid #3b3b3b;
      image-rendering: pixelated;
      box-shadow: 0 0 0 4px #000;
      min-height: 100vh;
      box-sizing: border-box;
      padding-bottom: 20px;
    }

    h1 {
      font-size: 16px;
      margin: 10px 0;
      color: #fff;
      text-shadow: 2px 2px #000;
    }

    .top-bar {
      background: #3b3b3b;
      color: #fff;
      padding: 6px;
      font-size: 10px;
      display: flex;
      justify-content: space-around;
      border-bottom: 4px solid #000;
    }

    .pixel-btn {
      margin: 4px;
      padding: 8px 10px;
      font-size: 10px;
      border-radius: 0;
      border: 3px solid #000;
      background: #f1c40f;
      color: #000;
      box-shadow: 3px 3px #000;
      cursor: pointer;
    }

    .pixel-btn:active {
      box-shadow: 0 0 #000;
      transform: translate(2px, 2px);
    }

    .chicken-img {
      width: 96px;
      margin: 8px auto;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    .stat-box {
      background: #ecf0f1;
      margin: 6px 10px;
      padding: 6px;
      border: 3px solid #000;
      font-size: 10px;
      text-align: left;
    }

    .label {
      font-size: 9px;
      color: #2c3e50;
    }

    .value {
      font-size: 11px;
      float: right;
    }

    #progressBar {
      width: 90%;
      height: 12px;
      background: #95a5a6;
      border: 3px solid #000;
      margin: 6px auto;
      box-sizing: border-box;
    }

    #progressFill {
      height: 100%;
      width: 0%;
      background: #2ecc71;
    }

    .egg-anim {
      animation: eggPop 0.3s steps(2, end);
    }

    @keyframes eggPop {
      0% { transform: scale(0.5); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .tabs {
      display: flex;
      justify-content: space-around;
      margin: 6px 6px 0 6px;
    }

    .tab-btn {
      flex: 1;
      margin: 0 2px;
      padding: 6px 0;
      font-size: 9px;
      border: 3px solid #000;
      background: #bdc3c7;
      box-shadow: 2px 2px #000;
      cursor: pointer;
    }

    .tab-btn.active {
      background: #f1c40f;
    }

    .tab-content {
      background: #ecf0f1;
      margin: 0 6px 6px 6px;
      padding: 6px;
      border: 3px solid #000;
      font-size: 9px;
      text-align: left;
      min-height: 80px;
    }

    .upgrade-item, .achievement-item {
      border-bottom: 1px solid #7f8c8d;
      padding: 4px 0;
    }

    .upgrade-title {
      font-size: 9px;
      font-weight: bold;
    }

    .upgrade-desc {
      font-size: 8px;
      color: #555;
    }

    .level-label {
      font-size: 10px;
      color: #fff;
      text-shadow: 2px 2px #000;
      margin-top: 4px;
    }

    .ref-box {
      background: #ecf0f1;
      margin: 6px 10px;
      padding: 6px;
      border: 3px solid #000;
      font-size: 9px;
      text-align: left;
    }

    .ref-link {
      font-size: 8px;
      word-break: break-all;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="top-bar">
      <div>TON: <span id="ton">0</span></div>
      <div>LVL: <span id="farmLevel">1</span></div>
      <div>XP: <span id="xp">0</span></div>
    </div>

    <h1>üêî PIXEL TON FARM</h1>

    <img src="https://i.imgur.com/4xvZp0P.png" class="chicken-img">

    <div class="stat-box">
      <div><span class="label">–ö—É—Ä—ã</span><span class="value" id="chickens">0</span></div>
      <div><span class="label">–Ø–π—Ü–∞</span><span class="value" id="eggs">0</span></div>
      <div><span class="label">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</span><span class="value"><span id="eggsPerHour">0</span>/h</span></div>
    </div>

    <div class="stat-box">
      <div><span class="label">–°–ª–µ–¥—É—é—â–µ–µ —è–π—Ü–æ</span><span class="value"><span id="timer">86</span> —Å–µ–∫</span></div>
      <div id="progressBar">
        <div id="progressFill"></div>
      </div>
    </div>

    <div class="stat-box">
      <div><span class="label">–ò–Ω–∫—É–±–∞—Ç–æ—Ä</span><span class="value" id="incStatus">–û–∂–∏–¥–∞–Ω–∏–µ</span></div>
      <div id="incubatorBar" style="width:90%;height:12px;background:#95a5a6;border:3px solid #000;margin:6px auto;">
        <div id="incubatorFill" style="height:100%;width:0%;background:#e67e22;"></div>
      </div>
    </div>

    <button class="pixel-btn" onclick="buyChickens()">–ö—É–ø–∏—Ç—å –∫—É—Ä (1 TON = 3000)</button>
    <button class="pixel-btn" onclick="sellEggs()">–ü—Ä–æ–¥–∞—Ç—å —è–π—Ü–∞ (100 —è–∏—Ü = 0.1 TON)</button>
    <button class="pixel-btn" onclick="startIncubator()">üß™ –ò–Ω–∫—É–±–∞—Ç–æ—Ä (100 —è–∏—Ü ‚Üí 95 –∫—É—Ä)</button>

    <div class="level-label">–§–µ—Ä–º–∞: <span id="farmName">–î–µ—Ä–µ–≤—è–Ω–Ω–∞—è —Ñ–µ—Ä–º–∞</span></div>

    <div class="ref-box">
      <div><b>–†–µ—Ñ–µ—Ä–∞–ª–∫–∞:</b> –ø—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ ‚Äî –≤—ã –æ–±–∞ –ø–æ–ª—É—á–∏—Ç–µ +100 —è–∏—Ü</div>
      <button class="pixel-btn" onclick="copyRef()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É</button>
      <div class="ref-link" id="refLinkText"></div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" id="tabUpgrades" onclick="switchTab('upgrades')">–£–ª—É—á—à–µ–Ω–∏—è</button>
      <button class="tab-btn" id="tabAchievements" onclick="switchTab('achievements')">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
    </div>

    <div class="tab-content" id="tabContentUpgrades">
      <div class="upgrade-item">
        <div class="upgrade-title">‚è± –£—Å–∫–æ—Ä–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ (5 TON)</div>
        <div class="upgrade-desc">–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —è–∏—Ü. –¢–µ–∫. —É—Ä–æ–≤–µ–Ω—å: <span id="speedLevelText">1</span></div>
        <button class="pixel-btn" style="margin-top:4px;" onclick="upgradeSpeed()">–ö—É–ø–∏—Ç—å</button>
      </div>
      <div class="upgrade-item">
        <div class="upgrade-title">üí∞ –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª–∏ (5 TON)</div>
        <div class="upgrade-desc">–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –¥–æ—Ö–æ–¥ —Å –ø—Ä–æ–¥–∞–∂–∏ —è–∏—Ü. –¢–µ–∫. —É—Ä–æ–≤–µ–Ω—å: <span id="profitLevelText">1</span></div>
        <button class="pixel-btn" style="margin-top:4px;" onclick="upgradeProfit()">–ö—É–ø–∏—Ç—å</button>
      </div>
    </div>

    <div class="tab-content" id="tabContentAchievements" style="display:none;">
      <div class="achievement-item" id="ach1">
        <div class="upgrade-title">üê£ –ü–µ—Ä–≤—ã–π –≤—ã–≤–æ–¥–æ–∫</div>
        <div class="upgrade-desc">–ù–∞–∫–æ–ø–∏ 1000 —è–∏—Ü.</div>
      </div>
      <div class="achievement-item" id="ach2">
        <div class="upgrade-title">üêî –§–µ—Ä–º–µ—Ä‚Äë–Ω–æ–≤–∏—á–æ–∫</div>
        <div class="upgrade-desc">–ö—É–ø–∏ 3000 –∫—É—Ä.</div>
      </div>
      <div class="achievement-item" id="ach3">
        <div class="upgrade-title">üè° –ù–æ–≤–∞—è —Ñ–µ—Ä–º–∞</div>
        <div class="upgrade-desc">–î–æ—Å—Ç–∏–≥–Ω–∏ 3 —É—Ä–æ–≤–Ω—è —Ñ–µ—Ä–º—ã.</div>
      </div>
    </div>

    <audio id="buySound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_7e5b45fc7e.mp3"></audio>
    <audio id="sellSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_7e5b45fc7e.mp3"></audio>
    <audio id="eggSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_7e5b45fc7e.mp3"></audio>
  </div>

  <script>
    // Telegram WebApp –∏ userId
    const tg = window.Telegram?.WebApp;
    let userId = null;

    try {
      userId = tg?.initDataUnsafe?.user?.id || null;
    } catch (e) {
      userId = null;
    }

    if (!userId) {
      const storedId = localStorage.getItem("userId");
      if (storedId) userId = storedId;
    } else {
      localStorage.setItem("userId", userId);
    }

    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã URL (—Ä–µ—Ñ–µ—Ä–∞–ª)
    const urlParams = new URLSearchParams(window.location.search);
    const ref = urlParams.get("ref");

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    let ton = parseFloat(localStorage.getItem("ton")) || 2;
    let chickens = parseInt(localStorage.getItem("chickens")) || 0;
    let eggs = parseFloat(localStorage.getItem("eggs")) || 0;
    let timer = parseFloat(localStorage.getItem("timer")) || 86;

    let speedLevel = parseInt(localStorage.getItem("speedLevel")) || 1;
    let profitLevel = parseInt(localStorage.getItem("profitLevel")) || 1;
    let xp = parseInt(localStorage.getItem("xp")) || 0;
    let farmLevel = parseInt(localStorage.getItem("farmLevel")) || 1;

    let ach1Done = localStorage.getItem("ach1Done") === "1";
    let ach2Done = localStorage.getItem("ach2Done") === "1";
    let ach3Done = localStorage.getItem("ach3Done") === "1";

    let refBonusReceived = localStorage.getItem("refBonusReceived") === "1";

    let eggInterval = 86 / speedLevel;

    // –ò–Ω–∫—É–±–∞—Ç–æ—Ä
    let incubatorActive = false;
    let incubatorTime = 60; // 1 –º–∏–Ω—É—Ç–∞
    let incubatorTimer = 0;

    function saveData() {
      localStorage.setItem("ton", ton);
      localStorage.setItem("chickens", chickens);
      localStorage.setItem("eggs", eggs);
      localStorage.setItem("timer", timer);
      localStorage.setItem("speedLevel", speedLevel);
      localStorage.setItem("profitLevel", profitLevel);
      localStorage.setItem("xp", xp);
      localStorage.setItem("farmLevel", farmLevel);
      localStorage.setItem("ach1Done", ach1Done ? "1" : "0");
      localStorage.setItem("ach2Done", ach2Done ? "1" : "0");
      localStorage.setItem("ach3Done", ach3Done ? "1" : "0");
      localStorage.setItem("refBonusReceived", refBonusReceived ? "1" : "0");
      if (userId) localStorage.setItem("userId", userId);
    }

    function farmNameByLevel(level) {
      if (level === 1) return "–î–µ—Ä–µ–≤—è–Ω–Ω–∞—è —Ñ–µ—Ä–º–∞";
      if (level === 2) return "–ö–∞–º–µ–Ω–Ω–∞—è —Ñ–µ—Ä–º–∞";
      if (level === 3) return "–ó–æ–ª–æ—Ç–∞—è —Ñ–µ—Ä–º–∞";
      if (level >= 4) return "–ê–ª–º–∞–∑–Ω–∞—è —Ñ–µ—Ä–º–∞";
      return "–§–µ—Ä–º–∞";
    }

    function updateAchievements() {
      if (!ach1Done && eggs >= 1000) {
        ach1Done = true;
        document.getElementById("ach1").style.background = "#2ecc71";
      }
      if (!ach2Done && chickens >= 3000) {
        ach2Done = true;
        document.getElementById("ach2").style.background = "#2ecc71";
      }
      if (!ach3Done && farmLevel >= 3) {
        ach3Done = true;
        document.getElementById("ach3").style.background = "#2ecc71";
      }
    }

    function updateUI() {
      document.getElementById("ton").innerText = ton.toFixed(2);
      document.getElementById("chickens").innerText = chickens;
      document.getElementById("eggs").innerText = eggs.toFixed(1);

      let eph = (chickens / 3000) * 42 * speedLevel;
      document.getElementById("eggsPerHour").innerText = eph.toFixed(1);

      document.getElementById("timer").innerText = Math.ceil(timer);
      document.getElementById("farmLevel").innerText = farmLevel;
      document.getElementById("farmName").innerText = farmNameByLevel(farmLevel);
      document.getElementById("xp").innerText = xp;
      document.getElementById("speedLevelText").innerText = speedLevel;
      document.getElementById("profitLevelText").innerText = profitLevel;

      let percent = ((eggInterval - timer) / eggInterval) * 100;
      if (percent < 0) percent = 0;
      if (percent > 100) percent = 100;
      document.getElementById("progressFill").style.width = percent + "%";

      // –ò–Ω–∫—É–±–∞—Ç–æ—Ä UI
      if (!incubatorActive) {
        document.getElementById("incStatus").innerText = "–û–∂–∏–¥–∞–Ω–∏–µ";
        document.getElementById("incubatorFill").style.width = "0%";
      }

      // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
      const refText = document.getElementById("refLinkText");
      if (userId) {
        const link = `https://t.me/fake_don_bot?start=ref_${userId}`;
        refText.textContent = link;
      } else {
        refText.textContent = "–û—Ç–∫—Ä–æ–π –∏–≥—Ä—É —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É.";
      }

      updateAchievements();
      saveData();
    }

    function addXP(amount) {
      xp += amount;
      if (xp >= farmLevel * 100) {
        xp = 0;
        farmLevel++;
      }
    }

    function buyChickens() {
      if (ton >= 1) {
        ton -= 1;
        chickens += 3000;
        addXP(10);
        document.getElementById("buySound").play();
        updateUI();
      }
    }

    function produceEggs() {
      if (chickens > 0) {
        eggs += (chickens / 3000) * 1;
        document.getElementById("eggs").classList.add("egg-anim");
        setTimeout(() => {
          document.getElementById("eggs").classList.remove("egg-anim");
        }, 300);
        document.getElementById("eggSound").play();
        addXP(1);
        updateUI();
      }
    }

    function sellEggs() {
      if (eggs >= 100) {
        let lots = Math.floor(eggs / 100);
        let earned = lots * 0.1 * 0.95 * profitLevel; // 5% –∫–æ–º–∏—Å—Å–∏—è
        ton += earned;
        eggs -= lots * 100;
        document.getElementById("sellSound").play();
        addXP(5);
        updateUI();
      }
    }

    function upgradeSpeed() {
      if (ton >= 5) {
        ton -= 5;
        speedLevel++;
        eggInterval = 86 / speedLevel;
        addXP(15);
        updateUI();
      }
    }

    function upgradeProfit() {
      if (ton >= 5) {
        ton -= 5;
        profitLevel++;
        addXP(15);
        updateUI();
      }
    }

    function switchTab(tab) {
      const upBtn = document.getElementById("tabUpgrades");
      const achBtn = document.getElementById("tabAchievements");
      const upContent = document.getElementById("tabContentUpgrades");
      const achContent = document.getElementById("tabContentAchievements");

      if (tab === "upgrades") {
        upBtn.classList.add("active");
        achBtn.classList.remove("active");
        upContent.style.display = "block";
        achContent.style.display = "none";
      } else {
        upBtn.classList.remove("active");
        achBtn.classList.add("active");
        upContent.style.display = "none";
        achContent.style.display = "block";
      }
    }

    function copyRef() {
      if (!userId) {
        alert("–û—Ç–∫—Ä–æ–π –∏–≥—Ä—É —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É.");
        return;
      }
      const link = `https://t.me/fake_don_bot?start=ref_${userId}`;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(link).then(() => {
          alert("–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
        }).catch(() => {
          alert("–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é:\n" + link);
        });
      } else {
        alert("–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é:\n" + link);
      }
    }

    // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å —Ä–µ—Ñ–µ—Ä–∞–ª—É (100 —è–∏—Ü –æ–¥–∏–Ω —Ä–∞–∑)
    function checkRefBonus() {
      if (ref && !refBonusReceived) {
        eggs += 100;
        refBonusReceived = true;
        saveData();
        alert("–¢—ã –∑–∞—à—ë–ª –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ! +100 —è–∏—Ü üéâ");
      }
    }

    // –ò–Ω–∫—É–±–∞—Ç–æ—Ä: –∑–∞–ø—É—Å–∫
    function startIncubator() {
      if (incubatorActive) {
        alert("–ò–Ω–∫—É–±–∞—Ç–æ—Ä —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!");
        return;
      }
      if (eggs < 100) {
        alert("–ù—É–∂–Ω–æ 100 —è–∏—Ü!");
        return;
      }

      eggs -= 100;
      incubatorActive = true;
      incubatorTimer = incubatorTime;

      document.getElementById("incStatus").innerText = "–í –ø—Ä–æ—Ü–µ—Å—Å–µ...";
      document.getElementById("incubatorFill").style.width = "0%";

      updateUI();
    }

    // –ì–ª–∞–≤–Ω—ã–π —Ç–∞–π–º–µ—Ä
    setInterval(() => {
      // –¢–∞–π–º–µ—Ä —è–∏—Ü
      if (timer > 0) {
        timer -= 1;
      } else {
        produceEggs();
        timer = eggInterval;
      }

      // –ò–Ω–∫—É–±–∞—Ç–æ—Ä
      if (incubatorActive) {
        incubatorTimer--;

        let percent = ((incubatorTime - incubatorTimer) / incubatorTime) * 100;
        if (percent < 0) percent = 0;
        if (percent > 100) percent = 100;
        document.getElementById("incubatorFill").style.width = percent + "%";

        if (incubatorTimer <= 0) {
          incubatorActive = false;

          // 95 –∫—É—Ä –∑–∞ 100 —è–∏—Ü
          chickens += 95;

          document.getElementById("incStatus").innerText = "–ì–æ—Ç–æ–≤–æ!";
          document.getElementById("eggSound").play();

          document.getElementById("chickens").classList.add("egg-anim");
          setTimeout(() => {
            document.getElementById("chickens").classList.remove("egg-anim");
          }, 300);
        }
      }

      updateUI();
    }, 1000);

    window.onload = () => {
      if (ach1Done) document.getElementById("ach1").style.background = "#2ecc71";
      if (ach2Done) document.getElementById("ach2").style.background = "#2ecc71";
      if (ach3Done) document.getElementById("ach3").style.background = "#2ecc71";
      checkRefBonus();
      updateUI();
    };
  </script>
</body>
</html>